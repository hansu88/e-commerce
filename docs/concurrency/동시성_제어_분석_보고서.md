# ë™ì‹œì„± ì œì–´ ë¶„ì„ ë³´ê³ ì„œ

## ğŸ“Œ ë¬¸ì œ ì •ì˜

1. **ì¿ í° ë°œê¸‰**: 100ê°œ í•œë„ì¸ë° 200ê°œê°€ ë°œê¸‰ë˜ëŠ” Over-issuance
2. **ì¬ê³  ì°¨ê°**: ì¬ê³  10ê°œì¸ë° 20ê°œê°€ íŒë§¤ë˜ëŠ” Over-selling

---

## ğŸ”§ í•´ê²° ë°©ë²•

### `synchronized` + `ConcurrentHashMap`

```java
public class CouponService {
    private final Map<Long, Object> lockMap = new ConcurrentHashMap<>();

    public UserCoupon issueCoupon(Long userId, Long couponId) {
        Object lock = lockMap.computeIfAbsent(couponId, k -> new Object());

        synchronized (lock) {
            // ë°œê¸‰ í•œë„ í™•ì¸
            if (coupon.getIssuedQuantity() >= coupon.getTotalQuantity()) {
                throw new IllegalStateException("ì¿ í° ë°œê¸‰ í•œë„ ì´ˆê³¼");
            }

            // ë°œê¸‰ ìˆ˜ëŸ‰ ì¦ê°€
            coupon.setIssuedQuantity(coupon.getIssuedQuantity() + 1);
            return userCouponRepository.save(userCoupon);
        }
    }
}
```

### í•µì‹¬ ì›ë¦¬

1. **ë¦¬ì†ŒìŠ¤ë³„ Lock ë¶„ë¦¬**: ì¿ í° Aì™€ ì¿ í° BëŠ” ë…ë¦½ì ìœ¼ë¡œ ë™ì‹œ ë°œê¸‰ ê°€ëŠ¥
2. **Check-Then-Act ì›ìì„±**: Read â†’ Check â†’ Updateê°€ ì¤‘ê°„ì— ëŠê¸°ì§€ ì•ŠìŒ
3. **ConcurrentHashMap**: thread-safeí•œ Lock ê°ì²´ ê´€ë¦¬

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

### CouponConcurrencyTest (3ê°œ ì‹œë‚˜ë¦¬ì˜¤)

| ì‹œë‚˜ë¦¬ì˜¤ | ì„¤ì • | ê²°ê³¼ |
|---------|------|------|
| ì •í™•í•œ í•œë„ | ì¿ í° 100ê°œ, ìš”ì²­ 100ê°œ | âœ… ì„±ê³µ 100, ì‹¤íŒ¨ 0 |
| í•œë„ ì´ˆê³¼ ë°©ì§€ | ì¿ í° 100ê°œ, ìš”ì²­ 200ê°œ | âœ… ì„±ê³µ 100, ì‹¤íŒ¨ 100 |
| Race Condition ë°©ì§€ | ì¿ í° 50ê°œ, ìš”ì²­ 100ê°œ | âœ… ë°œê¸‰ 50 = DB 50 |

### StockConcurrencyTest (4ê°œ ì‹œë‚˜ë¦¬ì˜¤)

| ì‹œë‚˜ë¦¬ì˜¤ | ì„¤ì • | ê²°ê³¼ |
|---------|------|------|
| ì •í™•í•œ ì°¨ê° | ì¬ê³  100, ìš”ì²­ 100 | âœ… ì¬ê³  0, ì„±ê³µ 100 |
| ì¬ê³  ë¶€ì¡± ì˜ˆì™¸ | ì¬ê³  100, ìš”ì²­ 150 | âœ… ì„±ê³µ 100, ì‹¤íŒ¨ 50 |
| ìŒìˆ˜ ë°©ì§€ | ì¬ê³  10, ìš”ì²­ 20 | âœ… ì¬ê³  0 (ìŒìˆ˜ ì—†ìŒ) |
| ë‹¤ì–‘í•œ ìˆ˜ëŸ‰ | ì¬ê³  50, ë‹¤ì–‘í•œ ìˆ˜ëŸ‰ | âœ… ì •í•©ì„± ë³´ì¥ |

```bash
$ ./gradlew test --tests "*ConcurrencyTest"

BUILD SUCCESSFUL in 2s
```

---

## âš ï¸ í•œê³„ ë° ê°œì„ 

### í˜„ì¬ í•œê³„
- ë‹¨ì¼ JVMì—ì„œë§Œ ë™ì‘ (ë¶„ì‚° í™˜ê²½ ë¶ˆê°€)
- Lock ê°ì²´ ëˆ„ì  ê°€ëŠ¥ì„±
- synchronized ë¸”ë¡œí‚¹ìœ¼ë¡œ ì²˜ë¦¬ëŸ‰ ì œí•œ

### í–¥í›„ ê°œì„ 
- Redis ë¶„ì‚° Lock
- Optimistic Lock íŒ¨í„´
- Lock ê°ì²´ ìë™ ì •ë¦¬

---

## ğŸ“š ì½”ë“œ ìœ„ì¹˜

- `CouponService.java:58`
- `StockService.java:42`
- `CouponConcurrencyTest.java`
- `StockConcurrencyTest.java`
