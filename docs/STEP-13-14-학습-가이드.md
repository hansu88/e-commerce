# STEP 13+14 í•™ìŠµ ê°€ì´ë“œ

## ğŸ¯ ì „ì²´ ëª©í‘œ

**STEP 13**: Redis Sorted Setìœ¼ë¡œ ì‹¤ì‹œê°„ ìƒí’ˆ ë­í‚¹ êµ¬í˜„
**STEP 14**: Redis INCR/SADDë¡œ ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ê°œì„ 

---

## ğŸ“– í•™ìŠµ íë¦„

### Phase 1: Redis ìë£Œêµ¬ì¡° ì´í•´
```
1. Sorted Set í•™ìŠµ â†’ docs/redis/Sorted-Set-ì‹¤ìŠµ.md
2. INCR/SADD í•™ìŠµ â†’ docs/redis/First-Come-First-Served-ì‹¤ìŠµ.md
3. Redis CLIë¡œ ì§ì ‘ ì‹¤ìŠµ
```

### Phase 2: Service ê³„ì¸µ ë„ì…
```
1. ì™œ Serviceë¥¼ ë§Œë“¤ì—ˆë‚˜?
   - UseCase: ë¹„ì¦ˆë‹ˆìŠ¤ íë¦„ ì œì–´
   - Service: Redis ë¡œì§ ì¬ì‚¬ìš©

2. RankingService
   - Redis Sorted Set ì¶”ìƒí™”
   - ì—¬ëŸ¬ UseCaseì—ì„œ ì‚¬ìš© ê°€ëŠ¥

3. CouponService
   - Redis ì„ ì°©ìˆœ ë¡œì§ ë¶„ë¦¬
   - í…ŒìŠ¤íŠ¸ ìš©ì´ì„± ì¦ê°€
```

### Phase 3: ì‹¤ì œ êµ¬í˜„
```
1. STEP 13: ìƒí’ˆ ë­í‚¹
2. STEP 14: ì„ ì°©ìˆœ ì¿ í°
```

---

## ğŸ¬ ì‹œë‚˜ë¦¬ì˜¤ 1: ìƒí’ˆ ë­í‚¹ (STEP 13)

### ë°°ê²½
```
ë¬¸ì œ: ì¸ê¸° ìƒí’ˆì„ ì–´ë–»ê²Œ ë³´ì—¬ì¤„ê¹Œ?
- í˜„ì¬: DB ì§‘ê³„ (ëŠë¦¼)
- ê°œì„ : Redis ì‹¤ì‹œê°„ ë­í‚¹ (ë¹ ë¦„)
```

### ì‹œë‚˜ë¦¬ì˜¤ A: ì‚¬ìš©ìê°€ ìƒí’ˆì„ ì£¼ë¬¸í•  ë•Œ

#### íë¦„
```
1. ì‚¬ìš©ì ìš”ì²­
   POST /api/orders
   {
     "userId": 1,
     "orderItems": [
       {"productOptionId": 5, "quantity": 2}  // ìƒí’ˆ 5ë²ˆ ì˜µì…˜, 2ê°œ
     ]
   }

2. CreateOrderUseCase.execute()
   â”œâ”€ ì¬ê³  ì°¨ê°
   â”œâ”€ ì¿ í° ì‚¬ìš©
   â”œâ”€ ì£¼ë¬¸ ì €ì¥
   â””â”€ ğŸ†• ë­í‚¹ ì—…ë°ì´íŠ¸ (updateProductRanking)
       â””â”€ ProductOption 5ë²ˆ â†’ Product 1ë²ˆ ì¡°íšŒ
           â””â”€ RankingService.incrementProductScore(1, 2)
               â””â”€ Redis: ZINCRBY product:ranking 2 "1"

3. Redis ìƒíƒœ ë³€í™”
   Before: product:ranking = {"1": 50}
   After:  product:ranking = {"1": 52}  â† 2ê°œ ì¦ê°€!
```

#### ì½”ë“œ íë¦„
```java
// CreateOrderUseCase.java
@Transactional
protected Order executeInternal(CreateOrderCommand command) {
    // ... ì£¼ë¬¸ ìƒì„± ë¡œì§ ...

    // ğŸ†• ë­í‚¹ ì—…ë°ì´íŠ¸
    updateProductRanking(command.getOrderItems());

    return savedOrder;
}

private void updateProductRanking(List<OrderItem> orderItems) {
    for (OrderItem item : orderItems) {
        // ProductOption â†’ Product ì¡°íšŒ
        ProductOption option = productOptionRepository
            .findById(item.getProductOptionId()).orElse(null);

        if (option != null) {
            // Redis ë­í‚¹ ì—…ë°ì´íŠ¸
            rankingService.incrementProductScore(
                option.getProductId(),  // ìƒí’ˆ 1ë²ˆ
                item.getQuantity()      // ìˆ˜ëŸ‰ 2ê°œ
            );
        }
    }
}
```

```java
// RankingService.java
public void incrementProductScore(Long productId, int quantity) {
    // Redis Sorted Set ì—…ë°ì´íŠ¸
    redisTemplate.opsForZSet()
        .incrementScore("product:ranking", "1", 2);

    log.debug("ìƒí’ˆ 1ë²ˆì— 2ê°œ ì¶”ê°€ â†’ ìƒˆ ì ìˆ˜: 52");
}
```

---

### ì‹œë‚˜ë¦¬ì˜¤ B: ì‚¬ìš©ìê°€ ë­í‚¹ì„ ì¡°íšŒí•  ë•Œ

#### íë¦„
```
1. ì‚¬ìš©ì ìš”ì²­
   GET /api/products/ranking?count=5

2. GetProductRankingUseCase.execute()
   â””â”€ RankingService.getTopProducts(5)
       â””â”€ Redis: ZREVRANGE product:ranking 0 4 WITHSCORES
           â†’ [("5", 120), ("3", 95), ("1", 52), ("7", 38), ("9", 25)]

3. Product ì •ë³´ ì¡°í•©
   â””â”€ DBì—ì„œ ìƒí’ˆ ì •ë³´ ì¡°íšŒ (IN ì¿¼ë¦¬ 1ë²ˆ)
       â†’ Product [5, 3, 1, 7, 9] ì¡°íšŒ

4. ì‘ë‹µ ìƒì„±
   [
     {productId: 5, name: "ì²­ë°”ì§€", price: 50000, totalSoldCount: 120, rank: 1},
     {productId: 3, name: "í‹°ì…”ì¸ ", price: 20000, totalSoldCount: 95, rank: 2},
     {productId: 1, name: "ìì¼“", price: 80000, totalSoldCount: 52, rank: 3},
     ...
   ]
```

#### ì½”ë“œ íë¦„
```java
// GetProductRankingUseCase.java
public List<ProductRankingResponseDto> execute(GetProductRankingCommand command) {
    // 1. Redisì—ì„œ TOP 5 ì¡°íšŒ
    List<RankingItem> topItems = rankingService.getTopProducts(5);
    // â†’ [(5, 120, 1), (3, 95, 2), (1, 52, 3), ...]

    // 2. Product ID ì¶”ì¶œ
    List<Long> productIds = [5, 3, 1, 7, 9];

    // 3. DBì—ì„œ Product ì¡°íšŒ (1ë²ˆë§Œ!)
    List<Product> products = productRepository.findAllById(productIds);

    // 4. ìˆœìœ„ ìˆœì„œëŒ€ë¡œ DTO ì¡°í•©
    for (RankingItem item : topItems) {
        Product product = productMap.get(item.getProductId());
        result.add(ProductRankingResponseDto.from(
            product,
            item.getSoldCount(),
            item.getRank()
        ));
    }

    return result;
}
```

```java
// RankingService.java
public List<RankingItem> getTopProducts(int count) {
    // Redis Sorted Set ì¡°íšŒ (ë†’ì€ ìˆœ)
    Set<TypedTuple<String>> topSet = redisTemplate.opsForZSet()
        .reverseRangeWithScores("product:ranking", 0, 4);

    // TypedTuple â†’ RankingItem ë³€í™˜
    // [("5", 120.0), ("3", 95.0), ...]
    // â†’ [(5, 120, 1), (3, 95, 2), ...]

    int rank = 1;
    for (TypedTuple<String> tuple : topSet) {
        items.add(new RankingItem(
            Long.parseLong(tuple.getValue()),  // productId
            tuple.getScore().intValue(),       // soldCount
            rank++                              // rank
        ));
    }

    return items;
}
```

---

### í•µì‹¬ í¬ì¸íŠ¸ (STEP 13)

#### 1. ì™œ Sorted Setì¸ê°€?
```
ê²Œì„ ë¦¬ë”ë³´ë“œì™€ ë™ì¼:
- ì ìˆ˜ ìˆœ ìë™ ì •ë ¬
- TOP N ì¡°íšŒ ë¹ ë¦„ (O(log N + M))
- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°€ëŠ¥

ëŒ€ì•ˆ:
- List: ì •ë ¬ ì•ˆ ë¨ âŒ
- Hash: ì ìˆ˜ ìˆœ ì •ë ¬ ì•ˆ ë¨ âŒ
- Sorted Set: ì™„ë²½! âœ…
```

#### 2. ProductOption â†’ Product ë³€í™˜ì´ ì™œ í•„ìš”í•œê°€?
```
ì£¼ë¬¸ ì‹œ:
- OrderItem.productOptionId = 5 (ì˜µì…˜ ID)
- í•˜ì§€ë§Œ ë­í‚¹ì€ ìƒí’ˆ ë‹¨ìœ„!

ProductOption 5ë²ˆ:
- productId: 1
- color: "ë¸”ë£¨"
- size: "L"

â†’ ë­í‚¹ì€ Product 1ë²ˆìœ¼ë¡œ ì§‘ê³„!
```

#### 3. Redis vs DB
```
Redis:
- ë©”ëª¨ë¦¬ (ë¹ ë¦„)
- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
- ì ìˆ˜ ìë™ ì •ë ¬

DB (ê¸°ì¡´ PopularProducts):
- í•˜ë£¨ 1ë²ˆ ì§‘ê³„ (ìŠ¤ì¼€ì¤„ëŸ¬)
- ëŠë¦¼ (ë””ìŠ¤í¬ I/O)
- ê³¼ê±° ë°ì´í„°

â†’ ë‘˜ ë‹¤ ìœ ì§€ (ëª©ì ì´ ë‹¤ë¦„)
```

---

## ğŸ¬ ì‹œë‚˜ë¦¬ì˜¤ 2: ì„ ì°©ìˆœ ì¿ í° (STEP 14)

### ë°°ê²½
```
ë¬¸ì œ: ì¿ í° 100ì¥ í•œì •, 1000ëª… ë™ì‹œ ì‹ ì²­!
- Before: DB ë¹„ê´€ì  ë½ (ëŠë¦¼, ë¶€í•˜)
- After: Redis ì„ ì°©ìˆœ (ë¹ ë¦„, íš¨ìœ¨)
```

### ì‹œë‚˜ë¦¬ì˜¤ A: 100ëª…ì´ ë™ì‹œì— ì¿ í° ì‹ ì²­

#### Before (ë¹„ê´€ì  ë½)
```
Thread-1: DB ë½ íšë“ â†’ ì¿ í° ì¡°íšŒ â†’ ì¬ê³  ì²´í¬ â†’ ë°œê¸‰ â†’ ì»¤ë°‹ â†’ ë½ í•´ì œ
Thread-2: ëŒ€ê¸° ì¤‘... (ë½ íšë“ê¹Œì§€ 100ms)
Thread-3: ëŒ€ê¸° ì¤‘... (ë½ íšë“ê¹Œì§€ 200ms)
...
Thread-100: ëŒ€ê¸° ì¤‘... (ë½ íšë“ê¹Œì§€ 10ì´ˆ!)

ë¬¸ì œì :
âŒ ëª¨ë“  ìš”ì²­ì´ DB ì ‘ê·¼
âŒ ë½ ê²½í•©ìœ¼ë¡œ ëŠë¦¼
âŒ í•œë„ ì´ˆê³¼í•´ë„ ì¼ë‹¨ ëŒ€ê¸°
```

#### After (Redis ì„ ì°©ìˆœ)
```
Thread-1~100: ë™ì‹œì— Redis ì²´í¬!

Redis ì²˜ë¦¬ (ì›ìì ):
Thread-1:  INCR coupon:issued:1 â†’ 1  (í†µê³¼!) â†’ DB ì €ì¥
Thread-2:  INCR coupon:issued:1 â†’ 2  (í†µê³¼!) â†’ DB ì €ì¥
...
Thread-10: INCR coupon:issued:1 â†’ 10 (í†µê³¼!) â†’ DB ì €ì¥
Thread-11: INCR coupon:issued:1 â†’ 11 (í•œë„ ì´ˆê³¼!) â†’ ì¦‰ì‹œ ì‹¤íŒ¨
Thread-12: INCR coupon:issued:1 â†’ 12 (í•œë„ ì´ˆê³¼!) â†’ ì¦‰ì‹œ ì‹¤íŒ¨
...
Thread-100: ì´ë¯¸ 11ì´ë¼ ì²´í¬ ìƒëµ â†’ ì¦‰ì‹œ ì‹¤íŒ¨

ê²°ê³¼:
âœ… 10ëª…ë§Œ DB ì ‘ê·¼
âœ… 90ëª…ì€ Redisì—ì„œ ë¹ ë¥´ê²Œ ì‹¤íŒ¨
âœ… ë™ì‹œì„± ì•ˆì „ (INCRì€ ì›ìì )
```

---

### íë¦„ ìƒì„¸

#### 1. ì‚¬ìš©ì 1ë²ˆ ì‹ ì²­ (ìµœì´ˆ)

```
1. ìš”ì²­
   POST /api/coupons/1/issue
   {
     "userId": 1
   }

2. IssueCouponUseCase.execute()
   â””â”€ ì¿ í° ì¡°íšŒ (DB, READ ONLY)
       â””â”€ Coupon 1ë²ˆ: totalQuantity = 100

   â””â”€ CouponService.tryIssueCoupon(1, 1, 100)

       â”œâ”€ ì¤‘ë³µ ì²´í¬ (SISMEMBER)
       â”‚   Redis: SISMEMBER coupon:users:1 "user:1"
       â”‚   â†’ 0 (ì—†ìŒ, ì²˜ìŒ ì‹ ì²­!)

       â”œâ”€ ë°œê¸‰ ìˆ˜ëŸ‰ ì¦ê°€ (INCR - ì›ìì !)
       â”‚   Redis: INCR coupon:issued:1
       â”‚   â†’ 1 (í˜„ì¬ 1ëª… ë°œê¸‰)

       â”œâ”€ í•œë„ ì²´í¬
       â”‚   1 <= 100? â†’ í†µê³¼!

       â””â”€ ì‚¬ìš©ì ì¶”ê°€ (SADD)
           Redis: SADD coupon:users:1 "user:1"
           â†’ 1 (ì¶”ê°€ ì„±ê³µ)

   â†’ return true (ë°œê¸‰ ê°€ëŠ¥!)

3. DB ì €ì¥ (saveToDatabase)
   â”œâ”€ Coupon.issuedQuantity ì¦ê°€ (1 â†’ 2)
   â””â”€ UserCoupon INSERT

4. ì‘ë‹µ
   {
     "couponId": 1,
     "issuedAt": "2025-12-02T10:00:00"
   }
```

#### 2. ì‚¬ìš©ì 1ë²ˆ ë‹¤ì‹œ ì‹ ì²­ (ì¤‘ë³µ)

```
1. ìš”ì²­
   POST /api/coupons/1/issue
   {
     "userId": 1
   }

2. CouponService.tryIssueCoupon(1, 1, 100)

   â”œâ”€ ì¤‘ë³µ ì²´í¬ (SISMEMBER)
   â”‚   Redis: SISMEMBER coupon:users:1 "user:1"
   â”‚   â†’ 1 (ìˆìŒ!)

   â””â”€ throw IllegalStateException("ì´ë¯¸ ë°œê¸‰ë°›ì€ ì¿ í°ì…ë‹ˆë‹¤.")

3. ì‘ë‹µ (ì—ëŸ¬)
   {
     "error": "ì´ë¯¸ ë°œê¸‰ë°›ì€ ì¿ í°ì…ë‹ˆë‹¤."
   }
```

#### 3. ì‚¬ìš©ì 100ë²ˆ ì‹ ì²­ (í•œë„ ì´ˆê³¼)

```
ìƒí™©: ì´ë¯¸ 100ëª… ë°œê¸‰ ì™„ë£Œ
Redis: coupon:issued:1 = "100"

1. ìš”ì²­
   POST /api/coupons/1/issue
   {
     "userId": 100
   }

2. CouponService.tryIssueCoupon(1, 100, 100)

   â”œâ”€ ì¤‘ë³µ ì²´í¬ (SISMEMBER)
   â”‚   Redis: SISMEMBER coupon:users:1 "user:100"
   â”‚   â†’ 0 (ì²˜ìŒ ì‹ ì²­)

   â”œâ”€ ë°œê¸‰ ìˆ˜ëŸ‰ ì¦ê°€ (INCR)
   â”‚   Redis: INCR coupon:issued:1
   â”‚   â†’ 101 (í•œë„ ì´ˆê³¼!)

   â”œâ”€ í•œë„ ì²´í¬
   â”‚   101 > 100? â†’ ì‹¤íŒ¨!

   â””â”€ ë¡¤ë°± (DECR)
       Redis: DECR coupon:issued:1
       â†’ 100 (ì›ë³µ)

   â†’ return false (ë°œê¸‰ ë¶ˆê°€!)

3. ì‘ë‹µ (ì—ëŸ¬)
   {
     "error": "ì¿ í°ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤."
   }
```

---

### ì½”ë“œ íë¦„ ìƒì„¸

#### IssueCouponUseCase.java

```java
public UserCoupon execute(IssueCouponCommand command) {
    // 1. ì¿ í° ì •ë³´ ì¡°íšŒ (READ ONLY, ë¹ ë¦„!)
    Coupon coupon = couponRepository.findById(command.getCouponId())
        .orElseThrow(() -> new IllegalArgumentException("ì¿ í°ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));

    // 2. Redis ì„ ì°©ìˆœ ì²´í¬ (í•µì‹¬!)
    boolean canIssue = couponService.tryIssueCoupon(
        command.getCouponId(),     // 1
        command.getUserId(),       // 1
        coupon.getTotalQuantity()  // 100
    );

    if (!canIssue) {
        // í•œë„ ì´ˆê³¼ ì‹œ ì¦‰ì‹œ ì‹¤íŒ¨ (DB ì ‘ê·¼ ì•ˆ í•¨!)
        throw new IllegalStateException("ì¿ í°ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // 3. Redis í†µê³¼ ì‹œì—ë§Œ DB ì €ì¥
    return saveToDatabase(command, coupon);
}
```

#### CouponService.java

```java
public boolean tryIssueCoupon(Long couponId, Long userId, int totalLimit) {
    String issuedKey = "coupon:issued:1";
    String usersKey = "coupon:users:1";
    String userValue = "user:1";

    // ì¤‘ë³µ ë°œê¸‰ ì²´í¬ (SISMEMBER)
    Boolean alreadyIssued = redisTemplate.opsForSet()
        .isMember(usersKey, userValue);

    if (Boolean.TRUE.equals(alreadyIssued)) {
        throw new IllegalStateException("ì´ë¯¸ ë°œê¸‰ë°›ì€ ì¿ í°ì…ë‹ˆë‹¤.");
    }

    // ë°œê¸‰ ìˆ˜ëŸ‰ ì¦ê°€ (INCR - ì›ìì !)
    Long issuedCount = redisTemplate.opsForValue()
        .increment(issuedKey, 1);
    // â†’ 1, 2, 3, ..., 100, 101, ...

    // í•œë„ ì²´í¬
    if (issuedCount == null || issuedCount > totalLimit) {
        // í•œë„ ì´ˆê³¼ ì‹œ ë¡¤ë°±
        redisTemplate.opsForValue().decrement(issuedKey, 1);
        log.info("ì¿ í° í•œë„ ì´ˆê³¼ - ë°œê¸‰: {}/{}", issuedCount, totalLimit);
        return false;
    }

    // ì‚¬ìš©ì Setì— ì¶”ê°€ (SADD - ì¤‘ë³µ ë°©ì§€)
    redisTemplate.opsForSet().add(usersKey, userValue);

    log.info("ì„ ì°©ìˆœ í†µê³¼ - ì‚¬ìš©ì: {}, ë°œê¸‰: {}/{}", userId, issuedCount, totalLimit);
    return true;
}
```

---

### í•µì‹¬ í¬ì¸íŠ¸ (STEP 14)

#### 1. ì™œ INCRì´ ì›ìì ì¸ê°€?

```
RedisëŠ” ì‹±ê¸€ ìŠ¤ë ˆë“œ:
ëª…ë ¹ì–´ë¥¼ í•œ ë²ˆì— í•˜ë‚˜ì”©ë§Œ ì²˜ë¦¬

Thread-1: INCR (ì½ê¸° 0 â†’ ê³„ì‚° 1 â†’ ì“°ê¸° 1)  â† ì™„ë£Œ!
Thread-2: INCR (ì½ê¸° 1 â†’ ê³„ì‚° 2 â†’ ì“°ê¸° 2)  â† Thread-1 ì™„ë£Œ í›„!

â†’ Race Condition ì—†ìŒ!

ë§Œì•½ ë©€í‹° ìŠ¤ë ˆë“œì˜€ë‹¤ë©´?
Thread-1: ì½ê¸° 0 â†’ ê³„ì‚° 1
Thread-2: ì½ê¸° 0 (ë™ì‹œ!) â†’ ê³„ì‚° 1
Thread-1: ì“°ê¸° 1
Thread-2: ì“°ê¸° 1 (ë®ì–´ì”€!)
â†’ 2ëª…ì¸ë° 1ë¡œ í‘œì‹œ
```

#### 2. ì™œ SADDë¡œ ì¤‘ë³µ ë°©ì§€?

```
Set = ì¤‘ë³µ ì—†ëŠ” ì§‘í•©

SADD coupon:users:1 "user:1"  â†’ 1 (ì¶”ê°€ ì„±ê³µ)
SADD coupon:users:1 "user:1"  â†’ 0 (ì´ë¯¸ ìˆìŒ, ì¶”ê°€ ì•ˆ ë¨)

íŠ¹ì§•:
- ìë™ ì¤‘ë³µ ì œê±°
- SISMEMBERë¡œ ë¹ ë¥´ê²Œ í™•ì¸ (O(1))
- SCARDë¡œ ë°œê¸‰ ë°›ì€ ì‚¬ìš©ì ìˆ˜ í™•ì¸
```

#### 3. ë¡¤ë°±ì´ ì™œ í•„ìš”í•œê°€?

```
ìƒí™©:
- totalLimit = 100
- í˜„ì¬ issuedCount = 100

Thread-101: INCR â†’ 101 (í•œë„ ì´ˆê³¼!)

ë¡¤ë°± ì•ˆ í•˜ë©´?
- Redis: 101
- DB: 100
- ë¶ˆì¼ì¹˜!

ë¡¤ë°± í›„:
- DECR â†’ 100
- Redis: 100
- DB: 100
- ì¼ì¹˜!
```

#### 4. Redis vs DB ì •í•©ì„±

```
ë¬¸ì œ:
1. Redis í†µê³¼ (count = 50)
2. DB ì €ì¥ ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)
3. RedisëŠ” 50ì¸ë° DBëŠ” 49! âŒ

í•´ê²°ì±… 1: @Transactional ìˆœì„œ
- DB ì €ì¥ ì„±ê³µ â†’ Redis ì¦ê°€
- DB ì €ì¥ ì‹¤íŒ¨ â†’ Redis ì¦ê°€ ì•ˆ í•¨

í•´ê²°ì±… 2: ìŠ¤ì¼€ì¤„ëŸ¬ ë™ê¸°í™” (ìš°ë¦¬ êµ¬í˜„)
- DB ì €ì¥ ë¨¼ì € (íŠ¸ëœì­ì…˜)
- RedisëŠ” ê·¼ì‚¬ê°’ (ì•½ê°„ ì°¨ì´ í—ˆìš©)
- syncWithDatabase() ë©”ì„œë“œë¡œ ì£¼ê¸°ì  ë™ê¸°í™”
```

---

## ğŸ¬ ì‹œë‚˜ë¦¬ì˜¤ 3: ì¿ í° ì¬ê³  ì¡°íšŒ

### ì‚¬ìš©ìê°€ ë‚¨ì€ ìˆ˜ëŸ‰ì„ í™•ì¸í•  ë•Œ

```
1. ìš”ì²­
   GET /api/coupons/1/stock

2. CouponController.getCouponStock()

   â”œâ”€ DBì—ì„œ ì¿ í° ì¡°íšŒ
   â”‚   â†’ Coupon 1ë²ˆ: totalQuantity = 100

   â””â”€ CouponServiceì—ì„œ Redis ì¡°íšŒ
       â”œâ”€ getIssuedCount(1)
       â”‚   Redis: GET coupon:issued:1
       â”‚   â†’ "75"

       â””â”€ getRemainingCount(1, 100)
           â†’ 100 - 75 = 25

3. ì‘ë‹µ
   {
     "couponId": 1,
     "totalQuantity": 100,
     "issuedCount": 75,
     "remainingCount": 25
   }
```

---

## ğŸ“Š ì „ì²´ ì•„í‚¤í…ì²˜

### ê³„ì¸µ êµ¬ì¡°

```
Controller (API)
   â†“
UseCase (ë¹„ì¦ˆë‹ˆìŠ¤ íë¦„)
   â†“
Service (Redis ë¡œì§) â† ğŸ†• STEP 13+14ì—ì„œ ì¶”ê°€!
   â†“
Repository (DB)
```

### ì—­í•  ë¶„ë‹´

```
ProductController
  â†“
GetProductRankingUseCase
  â†“
RankingService â† Redis Sorted Set
  â†“
ProductRepository (DB ì¡°íšŒ)
```

```
CouponController
  â†“
IssueCouponUseCase
  â†“
CouponService â† Redis INCR/SADD (ì„ ì°©ìˆœ ì²´í¬)
  â†“
CouponRepository (DB ì €ì¥)
```

---

## ğŸ”„ Before/After ë¹„êµ

### STEP 13: ìƒí’ˆ ë­í‚¹

#### Before (ì—†ìŒ)
```
- ì¸ê¸° ìƒí’ˆì€ DB ì§‘ê³„ (í•˜ë£¨ 1ë²ˆ)
- ì‹¤ì‹œê°„ ë­í‚¹ ì—†ìŒ
```

#### After (Redis Sorted Set)
```
- ì£¼ë¬¸ ì‹œë§ˆë‹¤ Redis ì—…ë°ì´íŠ¸
- ì‹¤ì‹œê°„ TOP N ì¡°íšŒ ê°€ëŠ¥
- ë¹ ë¦„ (ë©”ëª¨ë¦¬)
```

---

### STEP 14: ì„ ì°©ìˆœ ì¿ í°

#### Before (ë¹„ê´€ì  ë½)
```
100ëª… ì‹ ì²­ (í•œë„ 10ì¥)
â†’ 100ë²ˆ DB ì¿¼ë¦¬
â†’ ë½ ê²½í•©ìœ¼ë¡œ ëŠë¦¼
â†’ í‰ê·  500ms
```

#### After (Redis ì„ ì°©ìˆœ)
```
100ëª… ì‹ ì²­ (í•œë„ 10ì¥)
â†’ Redis ì²´í¬: 100ë²ˆ (ë¹ ë¦„!)
â†’ DB ì¿ ë¦¬: 10ë²ˆë§Œ
â†’ í‰ê·  50ms (10ë°° ë¹ ë¦„!)
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### Redis CLIë¡œ ì‹¤ìŠµ

#### 1. ìƒí’ˆ ë­í‚¹ ì‹œë®¬ë ˆì´ì…˜

```bash
# Docker Redis ì ‘ì†
docker exec -it redis-master redis-cli

# ì´ˆê¸° ë°ì´í„°
ZADD product:ranking 10 "1" 20 "2" 30 "3"

# ìƒí’ˆ 1ë²ˆ 5ê°œ íŒë§¤
ZINCRBY product:ranking 5 "1"

# TOP 3 ì¡°íšŒ
ZREVRANGE product:ranking 0 2 WITHSCORES
# ê²°ê³¼:
# 1) "3"
# 2) "30"
# 3) "2"
# 4) "20"
# 5) "1"
# 6) "15"

# ìƒí’ˆ 1ë²ˆ ìˆœìœ„ëŠ”?
ZREVRANK product:ranking "1"
# â†’ 2 (3ë“±, 0ë¶€í„° ì‹œì‘)
```

#### 2. ì„ ì°©ìˆœ ì¿ í° ì‹œë®¬ë ˆì´ì…˜

```bash
# ì´ˆê¸° ì„¤ì •
SET coupon:issued:1 0

# ì‚¬ìš©ì 1ë²ˆ ì‹ ì²­
INCR coupon:issued:1             # â†’ 1
SADD coupon:users:1 "user:1"     # â†’ 1 (ì¶”ê°€)

# ì‚¬ìš©ì 1ë²ˆ ë‹¤ì‹œ ì‹ ì²­ (ì¤‘ë³µ)
SISMEMBER coupon:users:1 "user:1"  # â†’ 1 (ì´ë¯¸ ìˆìŒ!)

# ì‚¬ìš©ì 2ë²ˆ ì‹ ì²­
INCR coupon:issued:1             # â†’ 2
SADD coupon:users:1 "user:2"     # â†’ 1 (ì¶”ê°€)

# í˜„ì¬ ìƒíƒœ
GET coupon:issued:1              # â†’ "2"
SMEMBERS coupon:users:1          # â†’ ["user:1", "user:2"]
```

---

## ğŸ’¡ í•µì‹¬

### Redis ìë£Œêµ¬ì¡° ì„ íƒ ê¸°ì¤€

| ì‚¬ìš© ì‚¬ë¡€ | ìë£Œêµ¬ì¡° | ì´ìœ  |
|----------|----------|------|
| ë­í‚¹ | Sorted Set | ì ìˆ˜ ìˆœ ìë™ ì •ë ¬, TOP N ë¹ ë¦„ |
| ì¹´ìš´íŒ… | String (INCR) | ì›ìì  ì¦ê°€, ë¹ ë¦„ |
| ì¤‘ë³µ ë°©ì§€ | Set (SADD) | ìë™ ì¤‘ë³µ ì œê±°, O(1) ì¡°íšŒ |
| ìºì‹± | String | ë‹¨ìˆœ key-value |
| ë¶„ì‚°ë½ | Hash (Redisson) | ë½ ë©”íƒ€ë°ì´í„° ì €ì¥ |

---

### Service vs UseCase

```
UseCase:
- ë¹„ì¦ˆë‹ˆìŠ¤ íë¦„ ì œì–´
- ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ì¡°í•©
- íŠ¸ëœì­ì…˜ ê²½ê³„

Service:
- íŠ¹ì • ê¸°ìˆ  ë¡œì§ (Redis, ì™¸ë¶€ API ë“±)
- ì¬ì‚¬ìš© ê°€ëŠ¥
- ë‹¨ì¼ ì±…ì„

ì˜ˆì‹œ:
IssueCouponUseCase {
    1. Coupon ì¡°íšŒ (Repository)
    2. Redis ì„ ì°©ìˆœ ì²´í¬ (CouponService) â† ì¬ì‚¬ìš© ê°€ëŠ¥!
    3. DB ì €ì¥ (Repository)
}
```

---

## ğŸ“š ì¶”ê°€ í•™ìŠµ ìë£Œ

### í”„ë¡œì íŠ¸ ë‚´ ë¬¸ì„œ
- `docs/redis/Sorted-Set-ì‹¤ìŠµ.md`
- `docs/redis/First-Come-First-Served-ì‹¤ìŠµ.md`
- `docs/redis/Lock-Strategy-ë¹„êµ.md`
- `docs/redis/Performance-Metrics.md`

### ì‹¤ìŠµ íŒŒì¼
- `RankingService.java` - Sorted Set ì‚¬ìš©
- `CouponService.java` - INCR/SADD ì‚¬ìš©
