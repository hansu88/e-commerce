# Redis ë½ ì „ëµ ë¹„êµ: Spin Lock vs Pub/Sub Lock

## ğŸ¯ ê°œìš”

ë¶„ì‚°ë½ êµ¬í˜„ ì‹œ 2ê°€ì§€ ëŒ€ê¸° ë°©ì‹ì´ ìˆìŠµë‹ˆë‹¤:
1. **Spin Lock (í´ë§)** - ê³„ì† í™•ì¸
2. **Pub/Sub Lock (ì´ë²¤íŠ¸)** - ì•Œë¦¼ ë°›ê¸° â­ (Redisson ê¸°ë³¸)

---

## 1ï¸âƒ£ Spin Lock (ìŠ¤í•€ ë½)

### ë™ì‘ ë°©ì‹
```
Thread-2ê°€ ë½ íšë“ ì‹œë„
   â†“
ë½ì´ ìˆë‚˜? â†’ ì—†ìŒ (ì‹¤íŒ¨)
   â†“
100ms ëŒ€ê¸°
   â†“
ë‹¤ì‹œ í™•ì¸: ë½ì´ ìˆë‚˜? â†’ ì—†ìŒ (ì‹¤íŒ¨)
   â†“
100ms ëŒ€ê¸°
   â†“
ë‹¤ì‹œ í™•ì¸: ë½ì´ ìˆë‚˜? â†’ ì—†ìŒ (ì‹¤íŒ¨)
   â†“
... (ë°˜ë³µ)
```

### ì½”ë“œ ì˜ˆì‹œ
```java
while (!lock.tryLock()) {
    Thread.sleep(100); // ê³„ì† ëŒ€ê¸°í•˜ë©´ì„œ í™•ì¸
}
```

### ì¥ì 
- âœ… êµ¬í˜„ ê°„ë‹¨
- âœ… Redis ê¸°ëŠ¥ ì ê²Œ ì‚¬ìš© (EXISTSë§Œ)

### ë‹¨ì 
- âŒ **CPU ë‚­ë¹„**: ê³„ì† Redis ì¿¼ë¦¬ ë‚ ë¦¼
- âŒ **ë„¤íŠ¸ì›Œí¬ ë¶€í•˜**: 100msë§ˆë‹¤ Redis í†µì‹ 
- âŒ **ë¶ˆí•„ìš”í•œ í™•ì¸**: ë½ì´ í•´ì œë˜ê¸° ì „ì—ë„ ê³„ì† í™•ì¸
- âŒ **ëŒ€ê¸° ì‹œê°„ ë¶ˆí™•ì‹¤**: ì–¸ì œ í•´ì œë ì§€ ëª¨ë¦„

---

## 2ï¸âƒ£ Pub/Sub Lock (íì„­ ë½) â­

### ë™ì‘ ë°©ì‹
```
Thread-2ê°€ ë½ íšë“ ì‹œë„
   â†“
ë½ì´ ìˆë‚˜? â†’ ìˆìŒ (ì‹¤íŒ¨)
   â†“
Pub/Sub ì±„ë„ êµ¬ë… (ëŒ€ê¸°)
   â†“
(Thread-1ì´ unlock)
   â†“
PUBLISH unlock ë©”ì‹œì§€ â†’ Thread-2 ê¹¨ì–´ë‚¨!
   â†“
ì¦‰ì‹œ ë½ íšë“ ì‹œë„ â†’ ì„±ê³µ!
```

### ì½”ë“œ ì˜ˆì‹œ (Redisson ë‚´ë¶€)
```java
// Thread-1: unlock ì‹œ
redis.publish("redisson_lock__channel:order:user:1", "unlock");

// Thread-2: ëŒ€ê¸° ì¤‘
redis.subscribe("redisson_lock__channel:order:user:1");
// ë©”ì‹œì§€ ë°›ìœ¼ë©´ ê¹¨ì–´ë‚¨
```

### ì¥ì 
- âœ… **CPU íš¨ìœ¨ì **: ëŒ€ê¸° ì¤‘ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ (sleep)
- âœ… **ë„¤íŠ¸ì›Œí¬ ì ˆì•½**: unlock ì‹œ 1ë²ˆë§Œ í†µì‹ 
- âœ… **ë¹ ë¥¸ ë°˜ì‘**: ë½ í•´ì œë˜ìë§ˆì ì¦‰ì‹œ ì•Œë¦¼
- âœ… **í™•ì¥ì„±**: ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ëŒ€ê¸°í•´ë„ ê´œì°®ìŒ

### ë‹¨ì 
- âŒ êµ¬í˜„ ë³µì¡ (Redissonì´ ë‹¤ í•´ì¤Œ)
- âŒ Redis Pub/Sub ê¸°ëŠ¥ í•„ìš”

---

## 3ï¸âƒ£ ì„±ëŠ¥ ë¹„êµ (ì´ë¡ )

### ì‹œë‚˜ë¦¬ì˜¤: 5ê°œ ìŠ¤ë ˆë“œê°€ ìˆœì°¨ ëŒ€ê¸°

| í•­ëª© | Spin Lock | Pub/Sub Lock |
|------|-----------|--------------|
| **Redis ì¿¼ë¦¬ ìˆ˜** | 100íšŒ+ (ê³„ì† í™•ì¸) | 5íšŒ (unlock ì•Œë¦¼) |
| **CPU ì‚¬ìš©ë¥ ** | ë†’ìŒ (busy waiting) | ë‚®ìŒ (event driven) |
| **ë„¤íŠ¸ì›Œí¬ ë¶€í•˜** | ë†’ìŒ (ë°˜ë³µ ì¿¼ë¦¬) | ë‚®ìŒ (ì•Œë¦¼ë§Œ) |
| **í‰ê·  ëŒ€ê¸° ì‹œê°„** | ë¶ˆí™•ì‹¤ (100ms ê°„ê²©) | ì¦‰ì‹œ (~1ms) |
| **í™•ì¥ì„±** | ë‚˜ì¨ (ìŠ¤ë ˆë“œâ†‘ = ë¶€í•˜â†‘) | ì¢‹ìŒ (ì´ë²¤íŠ¸ ë°©ì‹) |

### êµ¬ì²´ì  ì˜ˆì‹œ

**Spin Lock:**
```
Thread-1: 0ms  ë½ íšë“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1500ms í•´ì œ
Thread-2: 0ms  ëŒ€ê¸° (100msë§ˆë‹¤ í™•ì¸)
           â†“
         100ms  í™•ì¸ â†’ ì‹¤íŒ¨
         200ms  í™•ì¸ â†’ ì‹¤íŒ¨
         300ms  í™•ì¸ â†’ ì‹¤íŒ¨
         ...
        1500ms  í™•ì¸ â†’ ì‹¤íŒ¨
        1600ms  í™•ì¸ â†’ ì„±ê³µ! (ë½ íšë“)

â†’ 1600ms ë™ì•ˆ 16ë²ˆ Redis ì¿¼ë¦¬
â†’ 100ms ê°„ê²©ì´ë¼ 1500msì— í•´ì œë¼ë„ 1600msì— ì•Œê²Œ ë¨
```

**Pub/Sub Lock:**
```
Thread-1: 0ms  ë½ íšë“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1500ms í•´ì œ (PUBLISH)
Thread-2: 0ms  ëŒ€ê¸° (êµ¬ë… ì¤‘, sleep)
           â†“
        1500ms  unlock ì•Œë¦¼ ë°›ìŒ (ì¦‰ì‹œ ê¹¨ì–´ë‚¨!)
        1501ms  ë½ íšë“ ì„±ê³µ!

â†’ 1501ms (ê±°ì˜ ì¦‰ì‹œ)
â†’ Redis ì¿¼ë¦¬ 1ë²ˆ (PUBLISH)
```

---

## 4ï¸âƒ£ ìš°ë¦¬ í”„ë¡œì íŠ¸ ì„ íƒ: Pub/Sub Lock

### ì™œ Pub/Subë¥¼ ì„ íƒí–ˆë‚˜?

1. **Redisson ê¸°ë³¸ ì œê³µ**
   - ë³„ë„ êµ¬í˜„ ë¶ˆí•„ìš”
   - ê²€ì¦ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬

2. **ì„±ëŠ¥ ìš°ìˆ˜**
   - ì£¼ë¬¸ ì²˜ë¦¬ ì‹œ ì—¬ëŸ¬ ìŠ¤ë ˆë“œ ëŒ€ê¸° ê°€ëŠ¥
   - Spin Lockë³´ë‹¤ CPU íš¨ìœ¨ ì¢‹ìŒ

3. **í™•ì¥ì„±**
   - íŠ¸ë˜í”½ ì¦ê°€í•´ë„ ì„±ëŠ¥ ìœ ì§€
   - Redis ë¶€í•˜ ì ìŒ

### Redisson ë‚´ë¶€ ë™ì‘

```java
// tryLock() ë‚´ë¶€ (ë‹¨ìˆœí™”)
public boolean tryLock(long waitTime, TimeUnit unit) {
    // 1. ë½ íšë“ ì‹œë„
    if (tryAcquire()) {
        return true;
    }

    // 2. ì‹¤íŒ¨ ì‹œ Pub/Sub êµ¬ë…
    RFuture<RedissonLockEntry> future = subscribe();

    // 3. unlock ì•Œë¦¼ ëŒ€ê¸°
    Semaphore semaphore = future.get().getLatch();
    semaphore.tryAcquire(waitTime, unit);

    // 4. ê¹¨ì–´ë‚˜ì„œ ë‹¤ì‹œ ì‹œë„
    return tryAcquire();
}
```

---

## 5ï¸âƒ£ ì‹¤ë¬´ ì„ íƒ ê°€ì´ë“œ

### Spin Lockì„ ì“¸ ë•Œ
- âœ… ë½ ë³´ìœ  ì‹œê°„ì´ **ë§¤ìš° ì§§ìŒ** (ìˆ˜ ms)
- âœ… ëŒ€ê¸° ìŠ¤ë ˆë“œê°€ **1~2ê°œ**
- âœ… Redis Pub/Sub ì‚¬ìš© ë¶ˆê°€

### Pub/Sub Lockì„ ì“¸ ë•Œ â­
- âœ… ë½ ë³´ìœ  ì‹œê°„ì´ **ê¹€** (ìˆ˜ë°± ms ~ ì´ˆ)
- âœ… ëŒ€ê¸° ìŠ¤ë ˆë“œê°€ **ë§ìŒ** (3ê°œ ì´ìƒ)
- âœ… ì„±ëŠ¥ì´ ì¤‘ìš”
- âœ… Redis Pub/Sub ì‚¬ìš© ê°€ëŠ¥ (ì¼ë°˜ì )

**â†’ ëŒ€ë¶€ë¶„ì˜ ê²½ìš° Pub/Sub Lockì´ ìœ ë¦¬!**

---

## 6ï¸âƒ£ ì„±ëŠ¥ ì¸¡ì • ë°©ë²• (ì¶”í›„)

### ì¸¡ì • í•­ëª©
```java
// 1. Redis ì¿¼ë¦¬ ìˆ˜
long queryCount = redisMonitor.getQueryCount();

// 2. CPU ì‚¬ìš©ë¥ 
double cpuUsage = systemMonitor.getCpuUsage();

// 3. í‰ê·  ëŒ€ê¸° ì‹œê°„
long avgWaitTime = lockMetrics.getAvgWaitTime();

// 4. ë½ ì¶©ëŒ íšŸìˆ˜
long lockContentions = lockMetrics.getContentions();
```

### JMH ë²¤ì¹˜ë§ˆí¬ ì˜ˆì‹œ
```java
@Benchmark
public void spinLockBenchmark() {
    // Spin Lockìœ¼ë¡œ 1000ë²ˆ ë½ íšë“/í•´ì œ
}

@Benchmark
public void pubSubLockBenchmark() {
    // Pub/Sub Lockìœ¼ë¡œ 1000ë²ˆ ë½ íšë“/í•´ì œ
}
```

---

## ğŸ¯ í•µì‹¬ ì •ë¦¬

| ë¹„êµ | Spin Lock | Pub/Sub Lock |
|------|-----------|--------------|
| **ë°©ì‹** | ê³„ì† í™•ì¸ (polling) | ì•Œë¦¼ ë°›ê¸° (event) |
| **CPU** | ë†’ìŒ | ë‚®ìŒ |
| **ë„¤íŠ¸ì›Œí¬** | ë§ìŒ | ì ìŒ |
| **ë°˜ì‘ ì†ë„** | ëŠë¦¼ (ê°„ê²©ë§Œí¼) | ë¹ ë¦„ (ì¦‰ì‹œ) |
| **ì‚¬ìš© ì‚¬ë¡€** | ì§§ì€ ë½, ì ì€ ìŠ¤ë ˆë“œ | ê¸´ ë½, ë§ì€ ìŠ¤ë ˆë“œ |
| **ìš°ë¦¬ ì„ íƒ** | âŒ | âœ… |

**í•œ ì¤„ ìš”ì•½:**
```
Spin Lock = ê³„ì† í™•ì¸ (ë°”ì¨)
Pub/Sub Lock = ì•Œë¦¼ ë°›ê¸° (íš¨ìœ¨ì ) â­
â†’ Redissonì€ Pub/Sub ì‚¬ìš©!
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Redisson Lock êµ¬í˜„](https://github.com/redisson/redisson/wiki/8.-Distributed-locks-and-synchronizers)
- [Redis Pub/Sub](https://redis.io/docs/manual/pubsub/)
- [Lock-Free Programming](https://preshing.com/20120612/an-introduction-to-lock-free-programming/)
